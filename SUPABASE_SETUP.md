# Supabase Backend Setup Guide

This guide will help you set up Supabase as the backend for your Gamified Eco Education Platform.

## Why Supabase?

Currently, your app uses **localStorage**, which means:
- ❌ Data is stored only in the browser (not shared across users)
- ❌ When a student registers, teachers/admins can't see it
- ❌ Challenge submissions aren't visible to teachers
- ❌ No real-time updates

With **Supabase**, you get:
- ✅ Shared database accessible to all users
- ✅ Real-time updates when students submit challenges
- ✅ Teachers can see all students and submissions
- ✅ Data persists across sessions and devices

## Step 1: Create a Supabase Project

1. Go to [https://supabase.com](https://supabase.com)
2. Sign up or log in
3. Click "New Project"
4. Fill in:
   - **Name**: Eco Education Platform (or any name)
   - **Database Password**: Choose a strong password (save it!)
   - **Region**: Choose closest to you
5. Click "Create new project" (takes 1-2 minutes)

## Step 2: Get Your API Keys

1. In your Supabase project, go to **Settings** → **API**
2. Copy:
   - **Project URL** (under "Project URL")
   - **anon/public key** (under "Project API keys")

## Step 3: Set Environment Variables

1. Create a `.env` file in the `shadcn-ui` folder:
   ```env
   VITE_SUPABASE_URL=your_project_url_here
   VITE_SUPABASE_ANON_KEY=your_anon_key_here
   ```

2. Replace the values with your actual Supabase URL and key

## Step 4: Create Database Tables

1. In Supabase, go to **SQL Editor**
2. Click "New query"
3. Copy and paste the SQL below:

```sql
-- Create users table
CREATE TABLE IF NOT EXISTS users (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  email TEXT UNIQUE NOT NULL,
  password TEXT NOT NULL,
  -- Added super_admin role for full app control
  role TEXT NOT NULL CHECK (role IN ('student', 'teacher', 'admin', 'super_admin')),
  school_id TEXT NOT NULL,
  school_name TEXT NOT NULL,
  class_grade TEXT,
  eco_points INTEGER DEFAULT 0,
  level INTEGER DEFAULT 1,
  badges TEXT[] DEFAULT '{}',
  completed_lessons TEXT[] DEFAULT '{}',
  completed_quizzes TEXT[] DEFAULT '{}',
  completed_challenges TEXT[] DEFAULT '{}',
  -- Added account status for approvals (teacher/admin moderation)
  status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'pending', 'disabled')),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create challenge_submissions table
CREATE TABLE IF NOT EXISTS challenge_submissions (
  id TEXT PRIMARY KEY,
  challenge_id TEXT NOT NULL,
  user_id TEXT NOT NULL,
  user_name TEXT NOT NULL,
  school_id TEXT NOT NULL,
  submitted_at TIMESTAMPTZ DEFAULT NOW(),
  description TEXT NOT NULL,
  photo_url TEXT,
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected')),
  verified_by TEXT,
  verified_at TIMESTAMPTZ
);

-- Create indexes for better performance
CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);
CREATE INDEX IF NOT EXISTS idx_users_role ON users(role);
CREATE INDEX IF NOT EXISTS idx_users_school_id ON users(school_id);
CREATE INDEX IF NOT EXISTS idx_submissions_user_id ON challenge_submissions(user_id);
CREATE INDEX IF NOT EXISTS idx_submissions_school_id ON challenge_submissions(school_id);
CREATE INDEX IF NOT EXISTS idx_submissions_status ON challenge_submissions(status);

-- Enable Row Level Security (RLS)
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE challenge_submissions ENABLE ROW LEVEL SECURITY;

-- Create policies to allow all operations (for now - you can restrict later)
CREATE POLICY "Allow all operations on users" ON users
  FOR ALL USING (true) WITH CHECK (true);

CREATE POLICY "Allow all operations on submissions" ON challenge_submissions
  FOR ALL USING (true) WITH CHECK (true);

-- Enable real-time for submissions (so teachers see new submissions immediately)
ALTER PUBLICATION supabase_realtime ADD TABLE challenge_submissions;
```

### If your `users` table already exists

If you already created the `users` table with the older SQL, run this **update** script instead of recreating it:

```sql
-- 1) Add status column (for pending/disabled accounts)
ALTER TABLE users
ADD COLUMN IF NOT EXISTS status TEXT NOT NULL DEFAULT 'active';

-- 2) Relax and re-create the role check constraint to allow super_admin
-- NOTE: The old constraint name might be different (check in Supabase Table Editor → Constraints).
-- If your constraint is named something else, replace "users_role_check" below with that name.
ALTER TABLE users
DROP CONSTRAINT IF EXISTS users_role_check;

ALTER TABLE users
ADD CONSTRAINT users_role_check
CHECK (role IN ('student', 'teacher', 'admin', 'super_admin'));
```

### Changing a user’s email or password via SQL

> Important: the `password` column stores a **hashed** value generated by your app (using the `hashPassword` helper).  
> If you set a plain-text password here, that user will **not** be able to log in.

Examples:

```sql
-- Change a user's email
UPDATE users
SET email = 'new.email@example.com'
WHERE email = 'old.email@example.com';

-- Change a user's password (you must paste a hash generated by the app)
UPDATE users
SET password = 'PASTE_HASH_FROM_APP_HERE'
WHERE email = 'user@example.com';
```

If you want to quickly reset a password from the database, an easy workflow is:

1. Temporarily log a hashed password from your frontend (e.g. call `hashPassword('NewStrongPassword123')` and copy the result from the browser console).
2. Paste that hash into the `UPDATE users SET password = '...'` statement above.

### Adding a new super admin via SQL

You can manually insert another super admin user directly into Supabase:

```sql
INSERT INTO users (
  id,
  name,
  email,
  password,
  role,
  school_id,
  school_name,
  class_grade,
  eco_points,
  level,
  badges,
  completed_lessons,
  completed_quizzes,
  completed_challenges,
  status
) VALUES (
  'super-admin-2',                        -- id (any unique string)
  'Another Super Admin',                  -- name
  'superadmin2@ecolearn.com',            -- email
  'PASTE_HASH_FROM_APP_HERE',            -- password (hashed)
  'super_admin',                          -- role
  'global',                               -- school_id (used as a logical group)
  'EcoLearn Global',                      -- school_name
  NULL,                                   -- class_grade
  0,                                      -- eco_points
  1,                                      -- level
  '{}',                                   -- badges
  '{}',                                   -- completed_lessons
  '{}',                                   -- completed_quizzes
  '{}',                                   -- completed_challenges
  'active'                                -- status
);
```

You can change the `id`, `name`, and `email` as you like; just make sure:

- `id` is unique.
- `role` is exactly `'super_admin'`.
- `password` is a valid hash produced by your app.

4. Click "Run" to execute the SQL

## Step 5: Test the Setup

1. Start your dev server: `pnpm dev`
2. Register a new student account
3. Log in as a teacher/admin
4. You should now see the new student and their submissions!

## Troubleshooting

### "Supabase is not configured" warning
- Make sure your `.env` file is in the `shadcn-ui` folder
- Restart your dev server after creating `.env`
- Check that variable names start with `VITE_`

### "Error fetching users from Supabase"
- Check your Supabase URL and key are correct
- Make sure you've run the SQL schema
- Check browser console for detailed error messages

### Data not syncing
- Clear browser localStorage: `localStorage.clear()` in browser console
- Refresh the page
- Check Supabase dashboard → Table Editor to see if data is being saved

## Next Steps

1. **Add Authentication**: Use Supabase Auth instead of custom password hashing
2. **Add File Storage**: Use Supabase Storage for challenge photos
3. **Add Real-time**: Enable real-time subscriptions for live updates
4. **Add Security**: Restrict RLS policies based on user roles

## Support

If you encounter issues:
1. Check Supabase logs in the dashboard
2. Check browser console for errors
3. Verify your SQL schema was created correctly

